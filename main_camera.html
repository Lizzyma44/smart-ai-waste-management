<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Waste Detection Camera</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0/dist/mobilenet.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Header */
        .header {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            text-align: center;
            position: relative;
            z-index: 100;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 5px;
            color: #4CAF50;
        }

        .header p {
            color: #ccc;
            font-size: 1.1em;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid #333;
            border-top: 6px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.5em;
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .loading-details {
            color: #ccc;
            text-align: center;
            max-width: 400px;
        }

        /* Main Camera Container */
        .camera-container {
            position: relative;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #111;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Detection Overlay */
        .detection-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 10;
        }

        /* Main Detection Display */
        .detection-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(0, 0, 0, 0.8);
            padding: 30px 50px;
            border-radius: 20px;
            border: 3px solid #4CAF50;
            min-width: 300px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .detection-display.analyzing {
            border-color: #FFA726;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.05); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .detected-object {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #4CAF50;
        }

        .waste-category {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 15px;
            padding: 10px 20px;
            border-radius: 15px;
            display: inline-block;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .waste-category.dry {
            background: linear-gradient(135deg, #2E7D32, #4CAF50);
            color: white;
        }

        .waste-category.wet {
            background: linear-gradient(135deg, #8D6E63, #A1887F);
            color: white;
        }

        .confidence-display {
            font-size: 1.5em;
            color: #ccc;
            margin-bottom: 10px;
        }

        .processing-time {
            font-size: 1.2em;
            color: #999;
        }

        /* Corner Controls */
        .corner-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 50;
        }

        .corner-controls button {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: 2px solid #4CAF50;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .corner-controls button:hover {
            background: #4CAF50;
            transform: scale(1.05);
        }

        .corner-controls button:disabled {
            background: rgba(100, 100, 100, 0.5);
            border-color: #666;
            cursor: not-allowed;
            transform: none;
        }

        /* Status Bar */
        .status-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            text-align: center;
            font-size: 1.2em;
            z-index: 50;
        }

        .status-bar.success {
            color: #4CAF50;
        }

        .status-bar.error {
            color: #F44336;
        }

        .status-bar.info {
            color: #2196F3;
        }

        /* Auto Detection Indicator */
        .auto-indicator {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 20px;
            border: 2px solid #4CAF50;
            color: #4CAF50;
            font-weight: bold;
            z-index: 50;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.5; }
        }

        /* Dashboard Link */
        .dashboard-link {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            border: 2px solid #FF9800;
            font-weight: bold;
            z-index: 50;
            transition: all 0.3s ease;
        }

        .dashboard-link:hover {
            background: #FF9800;
            transform: scale(1.05);
        }

        /* No Detection State */
        .no-detection {
            opacity: 0.7;
            color: #999;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5em;
            }
            
            .detection-display {
                padding: 20px 30px;
                min-width: 250px;
            }
            
            .detected-object {
                font-size: 1.8em;
            }
            
            .waste-category {
                font-size: 2.2em;
            }
            
            .confidence-display {
                font-size: 1.2em;
            }
            
            .corner-controls button {
                padding: 8px 12px;
                font-size: 0.9em;
            }
        }

        /* Startup Animation */
        .fade-in {
            animation: fadeIn 1s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading AI Models...</div>
        <div class="loading-details" id="loadingDetails">
            Initializing TensorFlow.js and MobileNet for object recognition...
        </div>
    </div>

    <!-- Main Interface -->
    <div id="mainInterface" style="display: none;">
        <!-- Header -->
        <div class="header">
            <h1>ü§ñ Smart Waste Detection</h1>
            <p>AI-powered real-time waste classification</p>
        </div>

        <!-- Camera Container -->
        <div class="camera-container">
            <video id="video" autoplay muted playsinline></video>
            <canvas id="detectionCanvas" class="detection-overlay"></canvas>
            
            <!-- Auto Detection Indicator -->
            <div id="autoIndicator" class="auto-indicator" style="display: none;">
                üîÑ AUTO DETECT
            </div>
            
            <!-- Corner Controls -->
            <div class="corner-controls">
                <button id="startBtn">üé• Start</button>
                <button id="stopBtn" disabled>‚èπÔ∏è Stop</button>
                <button id="detectBtn" disabled>üîç Detect</button>
                <button id="autoToggle">üîÑ Auto</button>
            </div>
            
            <!-- Main Detection Display -->
            <div id="detectionDisplay" class="detection-display no-detection">
                <div class="detected-object" id="detectedObject">Ready</div>
                <div class="waste-category" id="wasteCategory">Show item to camera</div>
                <div class="confidence-display" id="confidenceDisplay">AI Detection System</div>
                <div class="processing-time" id="processingTime">Click Start to begin</div>
            </div>
            
            <!-- Dashboard Link -->
            <a href="complete_dashboard.html" class="dashboard-link">
                üìä Dashboard
            </a>
        </div>

        <!-- Status Bar -->
        <div id="statusBar" class="status-bar info">
            Ready - Click Start to begin waste detection
        </div>
    </div>

    <script>
        // Global variables
        let video = null;
        let detectionCanvas = null;
        let detectionCtx = null;
        let stream = null;
        let mobileNetModel = null;
        let cocoSsdModel = null;
        let isDetecting = false;
        let autoDetectInterval = null;
        let isAutoMode = false;

        // Waste classification mapping
        const wasteClassification = {
            // Wet/Organic Waste
            'banana': 'wet', 'apple': 'wet', 'orange': 'wet', 'broccoli': 'wet', 'carrot': 'wet',
            'hot dog': 'wet', 'pizza': 'wet', 'donut': 'wet', 'cake': 'wet', 'avocado': 'wet',
            'lemon': 'wet', 'sandwich': 'wet', 'food': 'wet', 'fruit': 'wet', 'vegetable': 'wet',
            
            // Dry/Recyclable Waste
            'bottle': 'dry', 'wine glass': 'dry', 'cup': 'dry', 'knife': 'dry', 'spoon': 'dry',
            'bowl': 'dry', 'cell phone': 'dry', 'laptop': 'dry', 'mouse': 'dry', 'keyboard': 'dry',
            'book': 'dry', 'scissors': 'dry', 'can': 'dry', 'plastic': 'dry', 'glass': 'dry',
            'metal': 'dry', 'paper': 'dry', 'cardboard': 'dry', 'aluminum': 'dry'
        };

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            await loadAIModels();
            initializeElements();
            setupEventListeners();
        });

        async function loadAIModels() {
            try {
                // Load MobileNet
                document.getElementById('loadingDetails').textContent = 'Loading MobileNet (Image Classification)...';
                mobileNetModel = await mobilenet.load();
                
                // Load COCO-SSD
                document.getElementById('loadingDetails').textContent = 'Loading COCO-SSD (Object Detection)...';
                cocoSsdModel = await cocoSsd.load();
                
                // Hide loading screen and show main interface
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('mainInterface').style.display = 'block';
                document.getElementById('mainInterface').classList.add('fade-in');
                
                updateStatus('‚úÖ AI Models loaded successfully! Ready for waste detection.', 'success');
                
            } catch (error) {
                console.error('Error loading AI models:', error);
                updateStatus('‚ùå Failed to load AI models. Please refresh the page.', 'error');
            }
        }

        function initializeElements() {
            video = document.getElementById('video');
            detectionCanvas = document.getElementById('detectionCanvas');
            detectionCtx = detectionCanvas.getContext('2d');
        }

        function setupEventListeners() {
            document.getElementById('startBtn').addEventListener('click', startCamera);
            document.getElementById('stopBtn').addEventListener('click', stopCamera);
            document.getElementById('detectBtn').addEventListener('click', detectNow);
            document.getElementById('autoToggle').addEventListener('click', toggleAutoMode);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.code === 'Space' && !e.target.matches('input, textarea, button')) {
                    e.preventDefault();
                    detectNow();
                }
                if (e.code === 'KeyA' && !e.target.matches('input, textarea, button')) {
                    e.preventDefault();
                    toggleAutoMode();
                }
            });
        }

        async function startCamera() {
            try {
                updateStatus('üé• Starting camera...', 'info');
                
                const constraints = {
                    video: {
                        width: { ideal: 1920 },
                        height: { ideal: 1080 },
                        facingMode: 'environment'
                    }
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    video.play();
                    
                    // Setup detection canvas
                    detectionCanvas.width = video.videoWidth;
                    detectionCanvas.height = video.videoHeight;
                    detectionCanvas.style.width = '100%';
                    detectionCanvas.style.height = '100%';
                    
                    // Update UI
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                    document.getElementById('detectBtn').disabled = false;
                    
                    // Update detection display
                    document.getElementById('detectedObject').textContent = 'Camera Active';
                    document.getElementById('wasteCategory').textContent = 'Show item to detect';
                    document.getElementById('confidenceDisplay').textContent = 'AI Ready';
                    document.getElementById('processingTime').textContent = 'Press Detect or enable Auto mode';
                    
                    updateStatus('‚úÖ Camera started! Show items for AI detection. Press SPACE to detect or A for auto mode.', 'success');
                };
                
            } catch (error) {
                console.error('Camera error:', error);
                updateStatus('‚ùå Camera access denied. Please allow camera permissions.', 'error');
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            if (autoDetectInterval) {
                clearInterval(autoDetectInterval);
                autoDetectInterval = null;
                isAutoMode = false;
                document.getElementById('autoIndicator').style.display = 'none';
            }
            
            // Clear detection canvas
            detectionCtx.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height);
            
            // Update UI
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('detectBtn').disabled = true;
            
            // Reset detection display
            document.getElementById('detectedObject').textContent = 'Ready';
            document.getElementById('wasteCategory').textContent = 'Show item to camera';
            document.getElementById('confidenceDisplay').textContent = 'AI Detection System';
            document.getElementById('processingTime').textContent = 'Click Start to begin';
            
            updateStatus('üì± Camera stopped', 'info');
        }

        function toggleAutoMode() {
            if (!stream) return;
            
            isAutoMode = !isAutoMode;
            
            if (isAutoMode) {
                startAutoDetection();
            } else {
                stopAutoDetection();
            }
        }

        function startAutoDetection() {
            if (autoDetectInterval) return;
            
            autoDetectInterval = setInterval(() => {
                if (stream && !isDetecting) {
                    detectCurrentFrame();
                }
            }, 2000);
            
            document.getElementById('autoIndicator').style.display = 'block';
            updateStatus('üîÑ Auto-detection enabled - AI analyzing every 2 seconds. Press A to disable.', 'success');
        }

        function stopAutoDetection() {
            if (autoDetectInterval) {
                clearInterval(autoDetectInterval);
                autoDetectInterval = null;
            }
            
            document.getElementById('autoIndicator').style.display = 'none';
            updateStatus('‚è∏Ô∏è Auto-detection disabled. Press SPACE to detect manually or A to enable auto.', 'info');
        }

        function detectNow() {
            if (stream && !isDetecting) {
                detectCurrentFrame();
            }
        }

        async function detectCurrentFrame() {
            if (!video || !stream || isDetecting || !mobileNetModel || !cocoSsdModel) return;
            
            isDetecting = true;
            const startTime = performance.now();
            
            try {
                // Show analyzing state
                const detectionDisplay = document.getElementById('detectionDisplay');
                detectionDisplay.classList.add('analyzing');
                
                document.getElementById('detectedObject').textContent = 'Analyzing...';
                document.getElementById('wasteCategory').textContent = 'Processing...';
                document.getElementById('confidenceDisplay').textContent = 'AI Working...';
                document.getElementById('processingTime').textContent = 'Please wait...';
                
                // Run AI models
                const [classifications, detections] = await Promise.all([
                    mobileNetModel.classify(video),
                    cocoSsdModel.detect(video)
                ]);
                
                const processingTime = (performance.now() - startTime) / 1000;
                
                // Process results
                const result = processAIResults(classifications, detections, processingTime);
                
                // Update main display
                updateMainDisplay(result);
                
                updateStatus(`üéØ Detected: ${result.detectedObject} ‚Üí ${result.wasteCategory} (${(result.confidence * 100).toFixed(1)}%)`, 'success');
                
            } catch (error) {
                console.error('Detection error:', error);
                updateStatus('‚ùå Detection failed', 'error');
                
                // Reset display
                document.getElementById('detectedObject').textContent = 'Error';
                document.getElementById('wasteCategory').textContent = 'Try again';
                document.getElementById('confidenceDisplay').textContent = 'Detection failed';
                document.getElementById('processingTime').textContent = 'Press SPACE to retry';
                
            } finally {
                isDetecting = false;
                document.getElementById('detectionDisplay').classList.remove('analyzing');
            }
        }

        function processAIResults(classifications, detections, processingTime) {
            // Get the top classification
            const topClassification = classifications[0];
            let detectedObject = topClassification.className;
            let confidence = topClassification.probability;
            
            // If we have object detections, prefer those
            if (detections.length > 0) {
                const topDetection = detections.reduce((prev, current) => 
                    (prev.score > current.score) ? prev : current
                );
                detectedObject = topDetection.class;
                confidence = topDetection.score;
            }
            
            // Determine waste category
            let wasteCategory = 'Unknown';
            
            if (wasteClassification[detectedObject]) {
                wasteCategory = wasteClassification[detectedObject] === 'wet' ? 'WET WASTE' : 'DRY WASTE';
            } else {
                const objectLower = detectedObject.toLowerCase();
                for (const [key, value] of Object.entries(wasteClassification)) {
                    if (objectLower.includes(key) || key.includes(objectLower)) {
                        wasteCategory = value === 'wet' ? 'WET WASTE' : 'DRY WASTE';
                        break;
                    }
                }
                
                if (wasteCategory === 'Unknown') {
                    const wetKeywords = ['food', 'fruit', 'vegetable', 'organic', 'eat'];
                    const dryKeywords = ['bottle', 'can', 'glass', 'plastic', 'metal', 'paper'];
                    
                    if (wetKeywords.some(keyword => objectLower.includes(keyword))) {
                        wasteCategory = 'WET WASTE';
                    } else if (dryKeywords.some(keyword => objectLower.includes(keyword))) {
                        wasteCategory = 'DRY WASTE';
                    } else {
                        wasteCategory = 'DRY WASTE';
                    }
                }
            }
            
            return {
                detectedObject: detectedObject,
                wasteCategory: wasteCategory,
                confidence: confidence,
                processingTime: processingTime
            };
        }

        function updateMainDisplay(result) {
            const detectionDisplay = document.getElementById('detectionDisplay');
            detectionDisplay.classList.remove('no-detection');
            
            // Update object name
            document.getElementById('detectedObject').textContent = result.detectedObject.toUpperCase();
            
            // Update waste category with styling
            const wasteCategoryElement = document.getElementById('wasteCategory');
            wasteCategoryElement.textContent = result.wasteCategory;
            wasteCategoryElement.className = 'waste-category ' + (result.wasteCategory === 'DRY WASTE' ? 'dry' : 'wet');
            
            // Update confidence
            document.getElementById('confidenceDisplay').textContent = `Confidence: ${(result.confidence * 100).toFixed(1)}%`;
            
            // Update processing time
            document.getElementById('processingTime').textContent = `Processed in ${result.processingTime.toFixed(2)}s`;
        }

        function updateStatus(message, type) {
            const statusBar = document.getElementById('statusBar');
            statusBar.textContent = message;
            statusBar.className = `status-bar ${type}`;
        }
    </script>
</body>
</html>